data_dir: /var/lib/vector

sources:
  logs:
    type: file
    include:
      - /var/log/demo/*.log
    ignore_older_secs: 600
    read_from: beginning

transforms:
  sid_substitute:
    type: remap
    inputs:
      - logs
    source: |
      # Load the SID map if not already cached
      if !exists(.sid_map) {
        # Read the file contents
        map_file = read_file("/etc/vector/sid_map.json") ?? "{}"
        .sid_map = parse_json!(map_file)
      }

      # Substitute SID with username if possible
      if is_string(.created_by_id) && exists(.sid_map[.created_by_id]) {
        .created_by_name = .sid_map[.created_by_id]
      } else {
        .created_by_name = "UNKNOWN"
      }

sinks:
  loki:
    type: loki
    inputs:
      - sid_substitute
    endpoint: http://loki:3100
    encoding:
      codec: json
    labels:
      job: vector
      host: ${HOSTNAME}
